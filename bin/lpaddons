#!/bin/bash

ODOO_SERVER_CONF=./odooconf

#export ODOOADDONS=`ls -d /usr/share/odoo-* /usr/share/odooext-* 2> /dev/null | grep -v odoo-addons | paste -sd ","`

ODOOADDONS="/usr/share/odoo-projB,/usr/share/odoo-projA,/usr/share/odoo-projC,/usr/share/odoo-projE,/usr/share/odoo-projD,/usr/share/odoo-projF,/usr/share/odoo-projG,/usr/share/odoo-projH,/usr/share/odoo-projI,/usr/share/odoo-projJ,/usr/share/odoo-projK,/usr/share/odoo-projL,/usr/share/odoo-projM"

# >>> CHECK REQUIREMENT
if ! command -v dialog &> /dev/null; then
    echo "'dialog' could not be found, is it installed?"
    exit
fi
#

# >>> FETCH AND PARSE $addons_path
addons_path=$( grep "addons_path=" "${ODOO_SERVER_CONF}" | cut -d "=" -f 2)
declare -A addons_path_map

IFS=','; read -ra ADDONSPATHSARR <<< "$addons_path"; IFS=' '
for addon in "${ADDONSPATHSARR[@]}"; do
    addons_path_map["$addon"]=1
done
#

# >>> PARSE $ODOOADDONS
declare MENUOPTS
ODOOADDONS=$(echo "$ODOOADDONS" | tr ',' '\n' | sort | tr '\n' ',')

IFS=','; read -ra ODOOADDONSARR <<< "$ODOOADDONS"; IFS=' '
for addon in "${ODOOADDONSARR[@]}"; do
    MENUOPTS+=$(echo "$addon " | cut -d "/" -f 4)
    MENUOPTS+=". "
    
    # check if $addon is in addons_path map.
    if [ ${addons_path_map["$addon"]} ]; then
	MENUOPTS+="on "
    else
	MENUOPTS+="off "
    fi
done
#

# >>> CREATE DIALOG
dialog --title "Select projects to include in addons_path" \
       --checklist "Select the modules you want to include in addons_path by marking them with '*' (press spacebar)" \
       40 60 30 \
       $MENUOPTS \
       2> lpaddons_output.txt
#

# >>> PARSE OUTPUT OF DIALOG
# The output is in lpaddons_output.txt and consists of project marked to be included in addons_path.
include=$( cat lpaddons_output.txt )
rm lpaddons_output.txt
read -ra INCLUDEODOOADDONSARR <<< "$include"

# >>> CREATE NEW addons_path
addons_path=""
for addon in "${INCLUDEODOOADDONSARR[@]}"; do
    addons_path+="/usr/share/${addon},"
done

# remove trailing comma 
if [ ${#addons_path} != 0 ]; then
    addons_path=${addons_path:0:-1}
fi 

# >>> WRITE NEW PATH
CWD="s/^addons_path.*=.*$/addons_path="${addons_path//"/"/"\/"}"/g"
sudo sed -ir "$CWD" "$ODOO_SERVER_CONF"

clear
